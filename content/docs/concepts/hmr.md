---
summary: 使用热模块替换（HMR）更新您的 AdonisJS 应用程序，无需重启进程。
---

# 热模块替换

热模块替换（HMR）是指在修改后重新加载 JavaScript 模块的过程，而无需重启整个进程。通常情况下，HMR 会导致更快的反馈循环，因为文件更改后，您不必等待整个进程重启。

HMR 这个术语在前端生态系统中已经使用了很多年，像 Vite 这样的工具可以热重载模块并将更改应用到网页，同时保持其现有状态。

然而，AdonisJS 执行的 HMR 要简单得多，并且与 Vite 或 Webpack 等工具大不相同。我们的 HMR 目标是提供更快的重载，仅此而已。

## 主要概念

### 不向浏览器传播任何更新

由于 AdonisJS 是一个后端框架，我们不负责维护前端应用程序的状态或向网页应用 CSS。因此，我们的 HMR 集成无法与您的前端应用程序通信并协调其状态。

实际上，并非每个 AdonisJS 应用程序都是浏览器渲染的网页应用。许多应用使用 AdonisJS 创建纯 JSON API，它们也可以从我们的 HMR 集成中受益。

### 仅适用于动态导入

大多数 HMR 工具使用代码转换来向编译输出中注入额外代码。在 AdonisJS 中，我们不太喜欢转译器，始终努力拥抱平台本身。因此，我们的 HMR 方法使用 [Node.js 加载器钩子](https://nodejs.org/api/module.html#customization-hooks) 并且仅适用于动态导入。

**好消息是，您的 AdonisJS 应用程序的所有关键部分默认都是动态导入的**。例如，控制器、中间件和事件监听器都是动态导入的，因此您可以从今天开始利用 HMR，而无需更改应用程序中的任何代码。

值得一提的是，动态导入模块的导入可以在顶层进行。例如，在路由文件中动态导入的控制器（控制器）可以对验证器、TSX 文件、模型和服务使用顶层导入，它们都可以从 HMR 中受益。

## 用法

所有官方入门套件都已更新为默认使用 HMR。但是，如果您有现有应用程序，则可以按如下方式配置 HMR。

将 [hot-hook](https://github.com/Julien-R44/hot-hook) npm 包作为开发依赖项安装。AdonisJS 核心团队创建了这个包，它也可以在 AdonisJS 应用程序之外使用。

```sh
npm i -D hot-hook
```

接下来，将以下配置复制粘贴到 `package.json` 文件中。`boundaries` 属性接受一个通配符模式数组，这些模式必须被视为 HMR 的范围。

```json
{
  "hotHook": {
    "boundaries": ["./app/controllers/**/*.ts", "./app/middleware/*.ts"]
  }
}
```

配置完成后，您可以使用 `--hmr` 标志启动开发服务器。

```sh
node ace serve --hmr
```

此外，您可能希望更新 `package.json` 文件中的 `dev` 脚本以使用这个新标志。

```json
{
  "scripts": {
    "dev": "node ace serve --hmr"
  }
}
```

## 完全重载与 HMR

:::note

本节解释了 `hot-hook` 的底层工作原理。如果您不想阅读扩展技术理论，可以跳过此部分 🤓

或者，如果您想要更深入的解释，请查看该包的 [README 文件](https://github.com/Julien-R44/hot-hook) .

:::

让我们了解 AdonisJS 何时会执行完全重载（重启进程）以及何时会热重载模块。

### 创建依赖树

使用 `--hmr` 标志时，AdonisJS 将使用 `hot-hook` 从 `bin/server.ts` 文件开始创建应用程序的依赖树，并监视此依赖树中的所有文件。

这意味着，如果您在应用程序源代码中创建了一个 TypeScript 文件，但从未在应用程序中的任何地方导入它，则此文件不会触发任何重载。它将被忽略，就像文件不存在一样。

### 识别边界

接下来，`hot-hook` 将使用配置中的 `boundaries` 数组来识别符合 HMR 条件的文件。

一般来说，您永远不应将配置文件、服务提供商或预加载文件注册为边界。这是因为这些文件通常会产生一些副作用，如果我们不清除这些副作用就重新加载它们，就会重新发生。这里有一些例子：

- `config/database.ts` 文件用于建立数据库连接。热重载此文件意味着关闭现有连接并重新创建连接。通过重新启动整个进程即可实现相同效果，而无需添加任何额外复杂性。

- `start/routes.ts` 文件用于注册路由。热重载此文件意味着删除已向框架注册的现有路由并重新注册它们。同样，重启进程更简单。

换句话说，我们可以说在 HTTP 请求期间导入/执行的模块应属于 HMR 边界，而引导应用程序所需的模块则不应属于。

### Performing reloads

一旦 `hot-hook` 识别了边界，它将对属于边界的动态导入模块执行 HMR，并对其余文件重启进程。
